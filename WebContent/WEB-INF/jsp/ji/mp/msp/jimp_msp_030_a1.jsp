<%@page pageEncoding="utf-8"%><%//jimp_msp_030_a1.jsp%><style>	.ui-th-column, .ui-jqgrid .ui-jqgrid-htable th.ui-th-column { white-space: normal; }	.ui-jqgrid-htable th{ text-align: center; }	.ui-th-ltr, .ui-jqgrid .ui-jqgrid-htable th.ui-th-ltr {border-left : 1px solid; border-left-color: #dcdcdc; }	.ui-th-rtl, .ui-jqgrid .ui-jqgrid-htable th.ui-th-rtl {border-right : 1px solid; border-right-color: #dcdcdc; }	</style><script language="javascript" src="<%=con_root%>/js/com-tree.js"></script>	<script type="text/javascript" src="<%=con_root%>/js/jquery.form.min.js"  charset="utf-8"></script><script language="javascript" src="<%=con_root%>/js/com-file.js"></script><form name="dataForm" id="dataForm" method="post" enctype="multipart/form-data"><input type="hidden" name="scode" 						id="scode" 				value="<%=scode%>" title="사이트코드" /><input type="hidden" name="pcode" 						id="pcode" 				value="<%=pcode%>" title="페이지코드"  /><input type="hidden" name="pstate" 						id="pstate" 			value="<%=pstate%>" title="페이지상태"  /><input type="hidden" name="curr_page" 					id="curr_page" 			value="<%=curr_page%>" title="현재페이지번호"  /><input type="hidden" name="show_rows" 					id="show_rows" 			value="<%=show_rows%>" title="현재페이지당데이터수"  /><input type="hidden" name="sBsOfcOrgCd" 				id="sBsOfcOrgCd" 		value="<c:out value='${R_MAP.param.sBsOfcOrgCd}'/>" /><input type="hidden" name="sFecKindCd" 					id="sFecKindCd" 		value="<c:out value='${R_MAP.param.sFecKindCd}'/>" /><input type="hidden" name="ichag_seq" 					id="ichag_seq"			value="" /><input type="hidden" name="delkey" 						id="delkey"			value="" /><input type="hidden" name="JSONDataList" id="JSONDataList" /><!--supply_box--><div class="supply_box">	<!--//board_A0_write-->	<div class="board_A0_V">		<table summary="<%=M_PATH_STR.substring(M_PATH_STR.lastIndexOf("::")+2).replaceAll("&amp;amp;","&")%>">			<caption><%=M_PATH_STR.substring(M_PATH_STR.lastIndexOf("::")+2).replaceAll("&amp;amp;","&")%>-설비분야</caption>			<colgroup>				<col width="200px" />				<col width="200px" />				<col width="200px" />				<col width="*" />				<col width="*" />				<col width="*" />			</colgroup>			<tbody>				<tr>									<th scope="row">설비분야</th>					<td colspan="4">						<select name="BS_OFC_ORG_CD" id="BS_OFC_ORG_CD" onchange="refreshGrid();" style="display:none;" title="설비분야 선택">							<option value="" <c:if test="'' == R_MAP.param.sBsOfcOrgCd}">selected="selected"</c:if>>--선택--</option>							<option value="NOTBsOfc" <c:if test="'NOTBsOfc' == R_MAP.param.sBsOfcOrgCd}">selected="selected"</c:if>>사업소외</option>							<c:forEach var="list" items="${R_MAP.rows}" varStatus="status">								<option value="<c:out value='${list.org_cd}'/>" <c:if test="${list.org_cd == R_MAP.param.sBsOfcOrgCd}">selected="selected"</c:if>><c:out value="${list.org_nm}"/></option>							</c:forEach>																	</select>																		<select name="FAC_KIND_CD" id="FAC_KIND_CD" onchange="refreshGrid();" title="설비 종류 선택">							<option value="" <c:if test="'' == R_MAP.param.sFecKindCd}">selected="selected"</c:if>>--선택--</option>							<c:forEach var="list" items="${R_MAP.m00101List}" varStatus="status">								<option value="<c:out value='${list.stdinfoDtlCd}'/>" <c:if test="${list.stdinfoDtlCd == R_MAP.param.sFecKindCd}">selected="selected"</c:if>><c:out value="${list.stdinfoDtlNm}"/></option>							</c:forEach>																			</select>					</td>				</tr>							</tbody>		</table>					</div>	<!--//board_A0_write-->		<div class="section mT25">		      <h3 class="fL "><span>&#8226;</span>담당자</h3>		      <p class="fR mB5">	         	<span class="btn_pack medium icon" id="btn_user_add" onclick="return false;"><span class="add"></span><a href="#" >추가</a></span> 	         	<span class="btn_pack medium icon" id="btn_user_add2" onclick="return false;"><span class="add"></span><a href="#" >추가2</a></span>	 			<span class="btn_pack medium icon"  id="btn_user_remove" onclick="return false;"><span class="delete"></span><a href="#" >삭제</a></span>		      </p>	</div>	    		<div class="section" id="jqGridDiv">		<table id='jqGrid'></table>	</div>			<!--button-->	<div class="button a_r mat_30">		<a href="#" class="btn_1 size_n" id="btn_sava" onclick="return false;">저장</a>		<a href="#" class="btn_2 size_n" id="btn_list" onclick="return false;">목록</a>	</div>	<!--//button--></div><!--//supply_box--></form><script type="text/javascript">var searchYn = false;	//TODO : $(function()	$(function(){		var cols =[{label:'번호'	,name:'row_seqno'				,index:'row_seqno'			,align:'center'		,width:'80'		,hidden:false		,sortable:false	}		,{label:'사업소'			,name:'bs_ofc_org_nm'			,index:'bs_ofc_org_nm'		,align:'center'		,width:'150'	,hidden:false		,sortable:false , formatter : fm_bs_off_nm }		,{label:'부서명'			,name:'chag_user_org_nm'		,index:'chag_user_org_nm'	,align:'center'		,width:'200'	,hidden:false		,sortable:false }   		,{label:'담당자명'			,name:'chag_user_nm'			,index:'chag_user_nm'		,align:'center'		,width:'100'	,hidden:false		,sortable:false 	}   		,{label:'직급'			,name:'chag_user_grd_nm'		,index:'chag_user_grd_nm'	,align:'center'		,width:'100'	,hidden:false		,sortable:false 	}   		,{label:'연락처'			,name:'moblphon'				,index:'moblphon'			,align:'center'		,width:'150'	,hidden:false		,sortable:false 	}   		,{label:'E-mail'		,name:'email'					,index:'email'				,align:'center'		,width:'200'	,hidden:false		,sortable:false 	}   		   		   		,{label:'사업소코드'		,name:'bs_ofc_org_cd'			,index:'bs_ofc_org_cd'		,align:'center'  	,width:'0'  	,hidden:true  		,sortable:false	}   		,{label:'담당자사번'		,name:'chag_emp_no'				,index:'chag_emp_no'		,align:'center'  	,width:'0'  	,hidden:true  		,sortable:false	}   		,{label:'key'			,name:'chag_seq'				,index:'chag_seq'			,align:'center'  	,width:'0'  	,hidden:true  		,sortable:false	}		];		//init grid		var grid = com.grid.init({		 id			: '#jqGrid' 		,viewrecords: true		,height		: 460		,autowidth  : true		,shrinkToFit: false		,rowNum		: 1000		,rowList	: 1000		,scroll 	: 1		,multiselect: true		,ajaxGridOptions: { contentType: "application/json;charset=utf-8" }		,gridComplete: function(){			mergeCellcomplet($(this));			//grid_win_resizeAuto();		}		,custom : { //custom			 cols : cols //컬럼정보 - 필수!			,navButton : {				excel : {					exportName	: $('.con_title>h3').text().trim() //엑셀다운로드시 사용할 파일명				}			}		}		,loadComplete: function(data){			if(searchYn){				//isLoadData(data);			}		}			,onSelectRow: function(id) {		}		});			    /* 그리드 크기를 조절할 수 있도록 한다. */	    //jQuery("#jqGrid").jqGrid('gridResize',{});				// 목록		$("#btn_list").click(function(e){			$("#dataForm").find("#pstate").val("L");			$("#dataForm").submit();		});				// 저장		$("#btn_sava").click(function(e){						var field = ["row_seqno","chag_emp_no","chag_seq"]; //grid 내 element id						/*if(isEmpty($("#BS_OFC_ORG_CD").val())){				alert("사업소를 선택해주세요.");				$("#BS_OFC_ORG_CD").focus();				return false;							}*/						if(isEmpty($("#FAC_KIND_CD").val())){				alert("설비분야를 선택해주세요.");				$("#FAC_KIND_CD").focus();				return false;							}						// 그리드의 데이터를 json데이터로 생성한다			$("#JSONDataList").val(JSONDataList("jqGrid",field));									if(confirm("저장하시겠습니까?")){								CmopenpageDisable();				$("#dataForm").find("#pstate").val("C");							////////////////////////////데이터 정리				var params = jQuery("#dataForm").serialize();								jQuery("#dataForm").ajaxSubmit({			    		type: "post",			            url: "<c:url value='/cmsajax.do'/>",			            data: params,			            async: false,			            dataType:"json",			            success: function(data){			            	if(data.result==true){			                	alert('담당자가 저장 되었습니다.');			                	$("#btn_list").trigger("click");			               	}else{								if(data.TRS_MSG!=""){									alert(''+data.TRS_MSG);								}else{									alert('담당자 저장중 오류가 발생했습니다.1');								}			            	   CmcloseLoading();			                }			             },					     error:function(request, status, error) {					    	 CmcloseLoading();					    	 alert('담당자 저장중 오류가 발생했습니다.2');			             }			    });				}		});				//사용자 추가		$("#btn_user_add").click(function(e){						//popWinScroll("<c:url value='/cmsmain.do'/>?scode=000008&pcode=000038&dto_FUN_FN=setOrgSawonAdd_cm_oam_<%=pcode%>&pstate=PF2&multi_yn=Y&check_yn=N&sorg_cd="+$("#BS_OFC_ORG_CD").val(), "orgSawonWinPop", 720, 700);			popWinScroll("<c:url value='/cmsmain.do'/>?scode=000008&pcode=000038&dto_FUN_FN=setOrgSawonAdd_cm_oam_<%=pcode%>&pstate=PF2&multi_yn=Y&check_yn=N&sorg_cd=", "orgSawonWinPop", 720, 700);					});					//사용자 추가2(레이어 팝업)		$("#btn_user_add2").click(function(e){				//multi_yn, check_yn,returnId,sorg_cd			//btn_sawon_search2_cm_oam_<%=pcode %>('Y', 'Y','',''+$("#BS_OFC_ORG_CD").val());			btn_sawon_search2_cm_oam_<%=pcode %>('Y', 'Y','','');		});					//사용자 삭제		$("#btn_user_remove").click(function(e){		  	var value = "";		  	var ids = jQuery('#jqGrid').jqGrid('getGridParam', 'selarrrow');		  				var delkey_val = "";			var delkey_col_row = "";			var delkey_col="chag_seq";			var org_delkey = "";					    for(i=0;i<ids.length;i++){		    	delkey_val = $("#jqGrid").jqGrid('getCell', ids[i], delkey_col);		    	delkey_col_row = $("#jqGrid").jqGrid('getCell', ids[i], 'row_seqno');		    	//console.log("delkey_col_row:=="+delkey_col_row+"::delkey_val:=="+delkey_val);		    	if(delkey_col_row!="" && delkey_val!=""){		    		org_delkey+= (org_delkey==""?"":",")+delkey_val; 		    	}		    }		    		    if(ids.length==0){		    	alert('삭제할 담당자를 선택하세요');		    	return;		    }		    		    for( var i=ids.length; i>0; i-- ){		       $('#jqGrid').jqGrid('delRowData', ids[i-1])		    }		    		    $("#delkey").val(org_delkey);		});					//$("#BS_OFC_ORG_CD option").not(":selected").attr("disabled","disabled");		$("#FAC_KIND_CD option").not(":selected").attr("disabled","disabled");				refreshGrid(false);		CmcloseLoading();					}).ajaxStart(function() {		//CmopenLoading();	}).ajaxStop(function() {		//CmcloseLoading();	});		var refreshGrid = function(){		//if($("#BS_OFC_ORG_CD").val()=="" || $("#FAC_KIND_CD").val()==""){		if($("#FAC_KIND_CD").val()==""){			return false;		}				$('#jqGrid').jqGrid('clearGridData', true);		CmopenLoading();		var _frm = document.dataForm;		_frm.action='<%=RequestURL%>';		searchYn = true;		var params = getGridParamDatas();		var formarr_params = "";				com.grid.reload('#jqGrid','<c:url value='/cmsajax.do'/>'+formarr_params,params);		setTimeout(CmcloseLoading,1000);			};		var getGridParamDatas = function(){		var _params = com.frm.getParamJSON2(document.dataForm);		_params.pstate = "XL2";		return _params;	};			//TODO : setOrgSawonAdd	//조직사원 검색팝업 리턴값 셋팅	function setOrgSawonAdd_cm_oam_<%=pcode%>(rtnArr){		//rtnArr[0]//직원아이디		//rtnArr[1]//직원명		//rtnArr[2]//최상위조직명		//rtnArr[3]//조직명		//rtnArr[4]//조직코드		//rtnArr[5]//returnId		//rtnArr[6]//조직유형코드		//rtnArr[7]//조직유형명		//rtnArr[8]//상위조직코드		//rtnArr[9]//최상위 조직코드		var ri =0;		var rj =0;		//var set_str1="";		//var set_str2="";		//console.log(rtnArr[0]);		for(ri=0;ri<rtnArr[0].length;ri++){			//set_str1=set_str1+rtnArr[ri][1];			//set_str2=set_str2+rtnArr[ri][2];			var ids = jQuery("#jqGrid").jqGrid('getDataIDs');			var addCnt  = 0;			var chkCnt  = 0;			//console.log("aa--"+i+"---"+checked_menu[i][1]);			// 중복된 사번이 있는지 확인			for(rj=0;rj < ids.length;rj++) {				addCnt = ids[rj];				addCnt = addCnt.replace('jqg', '');				//console.log("bb--"+i+"---"+j+"---"+rtnArr[i][6]+"----"+$("#jqGrid").jqGrid('getCell', ids[j],'chag_emp_no'));				//if(rtnArr[0][ri].indexOf($("#jqGrid2").jqGrid('getCell', ids[rj],'user_id')) > -1){				if(rtnArr[0][ri] == $("#jqGrid").jqGrid('getCell', ids[rj],'chag_emp_no')){					chkCnt++;				}			}						if(chkCnt == 0){				/*console.log("bb--"+ri+"------"+rtnArr[0][ri]);				console.log("bb--"+ri+"------"+rtnArr[1][ri]);				console.log("bb--"+ri+"------"+rtnArr[2][ri]);				console.log("bb--"+ri+"------"+rtnArr[3][ri]);				console.log("bb--"+ri+"------"+rtnArr[4][ri]);				console.log("bb--"+ri+"------"+rtnArr[5][ri]);				console.log("bb--"+ri+"------"+rtnArr[6][ri]);				console.log("bb--"+ri+"------"+rtnArr[7][ri]);				console.log("bb--"+ri+"------"+rtnArr[8][ri]);				console.log("bb--"+ri+"------"+rtnArr[9][ri]);				console.log("bb--"+ri+"------"+rtnArr[10][ri]);				console.log("bb--"+ri+"------"+rtnArr[11][ri]);				console.log("bb--"+ri+"------"+rtnArr[12][ri]);				console.log("bb--"+ri+"------"+rtnArr[13][ri]);						console.log("bb--"+ri+"------"+rtnArr[9][ri]+"----"+$("#BS_OFC_ORG_CD").val());				*/				//if($("#BS_OFC_ORG_CD").val()==rtnArr[9][ri]){			 		addCnt = parseInt(addCnt)+1;			   					 		var targetData = "";				 		targetData = { 				 						row_seqno       	:''				 						,bs_ofc_org_nm		:rtnArr[2][ri]				 						,chag_user_org_nm	:rtnArr[3][ri]				                 	  	,chag_user_nm      	:rtnArr[1][ri]				 					  	,bs_ofc_org_cd   	:rtnArr[9][ri]				 						,chag_emp_no        :rtnArr[0][ri]				 						,chag_seq			:''				 						,chag_user_grd_nm	:rtnArr[11][ri]				 						,moblphon			:rtnArr[15][ri]				 						,email				:rtnArr[14][ri]				 						,org_cs				:rtnArr[12][ri]				 						,org_nms			:rtnArr[13][ri]				 						 									 										 		}				 		jQuery("#jqGrid").jqGrid('addRowData',addCnt,targetData);				//}								}		}		}			//Grid 데이터 json 데이터로 반환	function JSONDataList(jqGrid,field) {		var colModel = $("#"+jqGrid).jqGrid('getGridParam','colModel');		var arrObj = new Array();		var ids = jQuery("#"+jqGrid).jqGrid('getDataIDs');		var _value ="";		var _type ="";	    for ( var i=0; i<ids.length; i++ ) {	        var vo = new Object();  	        for(var j=0;j<field.length;j++){	        	//console.log("i:="+i+":j:="+j+":ids:"+ids[i]+":"+field[j]+":tagName:="+$("#"+jqGrid+"_"+field[j]).prop("tagName")+":ch_length:="+$("#"+jqGrid+"_"+field[j]).children().length);	        	//console.log("i:="+i+":j:="+j+":ids:"+ids[i]+":"+field[j]+":cellval:="+$("#"+jqGrid).jqGrid('getCell', ids[i], field[j])+":===:"+$("#"+field[j]+ids[i]).val());	        	if($("#"+jqGrid).find("#"+field[j]+ids[i]).val()!=undefined){	        			        		_value = $("#"+jqGrid).find("#"+field[j]+ids[i]).val();	        		_type  = $("#"+jqGrid).find("#"+field[j]+ids[i]).attr("type");        			        	}else{	        		//console.log($("#"+jqGrid).find("#"+field[j]+ids[i]).prop("tagName"));	        		//멀티플 셀렉트인경우 셀렉트항목을 선택안하면 값이 없음 따라서 value를 직접셋팅해준다	        		if($("#"+jqGrid).find("#"+field[j]+ids[i]).prop("tagName")=="SELECT"){	        			_value = $("#"+jqGrid).find("#"+field[j]+ids[i]).val();	        		}else{	        			_value = $("#"+jqGrid).jqGrid('getCell', ids[i], field[j]);	        		}	        			        		_type  = "string";         			        	}	        		        	if(_value!=""){	            	if(_value.indexOf("'") > -1){	            		//_value = htmlSpclCharsDecode(value);	            		_value = StrreplaceAll(_value,"'","&#39;");	            	}         			        	}        		        		    		if(_type=="radio"){	    			//console.log("field["+j+"]:=="+field[j]+"::ids["+i+"]:==="+ids[i]+":=="+$("#"+jqGrid+" input:radio[id="+field[j]+ids[i]+"]").is(":checked"));	    			if($("#"+jqGrid+" input:radio[id="+field[j]+ids[i]+"]").is(":checked")){	    				$("#"+jqGrid+" input:radio[id="+field[j]+ids[i]+"]").each(function(){	    					if($(this).is(":checked")){	    						_value = $(this).val();	    					}	    				});	    					    					eval("vo."+field[j]+"='"+_value+"';");	    			}else{	    				_value = "";	    					eval("vo."+field[j]+"='"+_value+"';");	    			}	    		}else if(_type=="checkbox"){	    			//console.log("field["+j+"]:=="+field[j]);	    		}else{	    					    		if(_value==undefined){		    			eval("vo."+field[j]+"='';");			    		}else{		    			eval("vo."+field[j]+"='"+_value+"';");		    		} 	    		}        		        		 	        }	        arrObj.push(vo);   	    }	    return JSON.stringify(arrObj);	}			var fm_bs_off_nm = function(cellvalue, options, rowObject){		var returnCell = "";		var org_nms_sp = rowObject.org_nms.split("::");		var org_cs_sp = rowObject.org_cs.split("::");		if(org_cs_sp.length < 3){			if(org_cs_sp.length == 1){				returnCell = "사업소외";			}else{				if(org_cs_sp[1]=="A000"){					returnCell = org_nms_sp[1];				}else{					returnCell = "사업소외";				}			}		}else{			if(org_cs_sp[1]=="A000"){				returnCell = org_nms_sp[2];			}else{				returnCell = "사업소외";			}				}		return returnCell;	};		//////////////////////////////사원선택 팝업창 ///////////////////////////////<%@include file="/WEB-INF/jsp/ji/cm/oam/jicm_oam_010_i2.jsp"%>//////////////////////////////사원선택 팝업창 ///////////////////////////////	</script>